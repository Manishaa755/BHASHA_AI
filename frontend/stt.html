<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bhasha ‚Äî Speech ‚Üí Text Chat</title>

    <!-- Backend base (change if needed) -->
    <script>window.API_BASE = "http://127.0.0.1:8000";</script>

    <!-- Fonts: Indic support so Gujarati/Hindi/Tamil etc. render properly -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans:wght@400;600&family=Noto+Sans+Devanagari:wght@400;600&family=Noto+Sans+Gujarati:wght@400;600&family=Noto+Sans+Bengali:wght@400;600&family=Noto+Sans+Tamil:wght@400;600&family=Noto+Sans+Telugu:wght@400;600&family=Noto+Sans+Malayalam:wght@400;600&family=Noto+Sans+Gurmukhi:wght@400;600&family=Noto+Sans+Kannada:wght@400;600&family=Noto+Sans+Oriya:wght@400;600&family=Noto+Sans+Assamese:wght@400;600&display=swap"
      rel="stylesheet">

    <link rel="icon" href="data:,">
    <style>
    :root{
      color-scheme: dark;
      --bg:#0a0b0f; --card:#0f1320; --muted:#9aa4b2; --text:#eef2f7;
      --line:rgba(255,255,255,.08); --brand1:#6d5efc; --brand2:#00e7f0;
      --green:#22c55e; --red:#ef4444; --radius:16px;
      --shadow:0 20px 70px rgba(0,0,0,.45);
      --glass:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(109,94,252,.18), transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, rgba(0,231,240,.12), transparent 50%),
        var(--bg);
      color:var(--text);
      font-family: Inter, "Noto Sans", "Noto Sans Devanagari", "Noto Sans Gujarati", "Noto Sans Bengali",
                   "Noto Sans Tamil", "Noto Sans Telugu", "Noto Sans Malayalam", "Noto Sans Gurmukhi",
                   "Noto Sans Kannada", "Noto Sans Oriya", "Noto Sans Assamese",
                   ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{color:inherit; text-decoration:none}
    .container{max-width:1120px; margin:0 auto; padding:24px}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 0 8px;}
    .logo{display:flex; align-items:center; gap:10px; font-weight:700}
    .logo-badge{width:34px; height:34px; border-radius:10px; background: conic-gradient(from 180deg at 50% 50%, var(--brand1), var(--brand2)); display:grid; place-items:center; color:white; font-size:18px; box-shadow: var(--shadow);}
    .navlinks{display:flex; gap:12px; align-items:center; opacity:.92}
    .navlinks a{padding:8px 12px; border-radius:10px; border:1px solid transparent}
    .navlinks a.active{border-color: var(--line); background: rgba(255,255,255,.05)}

    .hero{margin-top:10px; padding:28px; border-radius:var(--radius); background: var(--glass); border:1px solid var(--line); box-shadow: var(--shadow);}
    .hero h1{margin:6px 0 8px; font-size:28px; letter-spacing:.3px}
    .hero p{margin:0; color:var(--muted)}

    .panel{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow: var(--shadow); padding:18px;}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .btn{border:none; color:white; font-weight:600; cursor:pointer; border-radius:14px; padding:12px 16px; letter-spacing:.2px; background: linear-gradient(135deg, var(--brand1), var(--brand2));}
    .btn.good{background:linear-gradient(135deg, #10b981, #22c55e)}
    .btn.bad{background:#ef4444}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .select{background:#12182a; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:10px 12px;}
    .pill{padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px}

    .chat{display:grid; gap:14px; max-height:min(65dvh,560px); overflow:auto; padding:8px; scroll-behavior:smooth}
    .msg{display:grid; grid-template-columns:36px 1fr; align-items:start; gap:10px; animation:pop .2s ease}
    @keyframes pop{from{transform:translateY(4px);opacity:0} to{transform:none;opacity:1}}
    .avatar{width:36px;height:36px;display:grid;place-items:center;border-radius:50%;background:#0f1220;border:1px solid var(--line)}
    .bubble{border:1px solid var(--line); background:#0f1117; border-radius:14px; padding:12px 14px; line-height:1.55; word-wrap:break-word}
    .user .bubble{background:#172033}
    .meta{color:var(--muted); font-size:12px; margin-top:6px}

    .toast{position:fixed; left:50%; translate:-50% 0; bottom:24px; background:#12182a; color:#e9f2ff; border:1px solid var(--line); padding:10px 14px; border-radius:12px; box-shadow: var(--shadow); font-size:13px; opacity:0; pointer-events:none; transform:translateY(6px); transition:opacity .2s ease, transform .2s ease}
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
  </head>
  <body>
    <div class="container">
      <nav class="nav">
        <div class="logo"><div class="logo-badge">‡§≠</div><div>Bhasha</div></div>
        <div class="navlinks">
          <a href="/static/index.html">Home</a>
          <a class="active" href="/static/stt.html">STT</a>
          <a href="/static/tts.html">TTS</a>
          <a href="/static/sts.html">Speech‚ÜîSpeech</a>
        </div>
      </nav>

      <section class="hero">
        <h1>Speech ‚Üí Text Chat</h1>
        <p>Speak naturally in your language. We transcribe with Whisper and
          reply with GPT in the same language.</p>
      </section>

      <section class="panel" style="margin-top:16px">
        <div class="row">
          <button id="recBtn" class="btn good">üéôÔ∏è Start</button>
          <button id="stopBtn" class="btn bad" disabled>‚èπ Stop</button>

          <div>
            <label for="langHint"
              style="color:var(--muted); font-size:13px">Language hint
              (optional)</label><br />
            <select id="langHint" class="select"
              title="Helps recognition if you know the language">
              <option value="auto" selected>Auto (detect)</option>
              <optgroup label="Common Indian languages">
                <option value="hi">Hindi (hi)</option>
                <option value="bn">Bengali/Bangla (bn)</option>
                <option value="gu">Gujarati (gu)</option>
                <option value="mr">Marathi (mr)</option>
                <option value="ta">Tamil (ta)</option>
                <option value="te">Telugu (te)</option>
                <option value="kn">Kannada (kn)</option>
                <option value="ml">Malayalam (ml)</option>
                <option value="pa">Punjabi/Gurmukhi (pa)</option>
                <option value="or">Odia/Oriya (or)</option>
                <option value="as">Assamese (as)</option>
                <option value="ur">Urdu (ur)</option>
              </optgroup>
              <optgroup label="Other">
                <option value="en">English (en)</option>
              </optgroup>
            </select>
          </div>

          <span id="status" class="pill">Idle</span>
        </div>
      </section>

      <section class="panel" style="margin-top:14px">
        <div id="chat" class="chat">
          <!-- initial assistant message -->
          <div class="msg bot">
            <div class="avatar" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path
                  d="M12 2l2.2 5.6L20 10l-5.3 2.3L12 18l-2.7-5.7L4 10l5.8-2.4L12 2z"
                  fill="#8ab4ff" />
              </svg>
            </div>
            <div>
              <div class="bubble">Hi! I‚Äôm your multilingual assistant. Tap the
                mic and ask me anything.</div>
              <div class="meta">Assistant</div>
            </div>
          </div>
        </div>
      </section>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </div>

    <script>
    const API_BASE = (window.API_BASE || "").replace(/\/$/, "");
    const chat = document.getElementById('chat');
    const recBtn = document.getElementById('recBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const langHintSel = document.getElementById('langHint');
    const toast = document.getElementById('toast');

    let mediaRecorder, chunks = [], recording = false, busy = false;

    function setStatus(t){ statusEl.textContent = t; }
    function showToast(msg, ms=2200){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=> toast.classList.remove('show'), ms);
    }
    function avatar(isUser=false){
      const a = document.createElement('div');
      a.className = 'avatar';
      a.innerHTML = isUser
        ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="#9dd1ff"/><path d="M4 20c2-3 5-5 8-5s6 2 8 5" stroke="#9dd1ff"/></svg>'
        : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l2.2 5.6L20 10l-5.3 2.3L12 18l-2.7-5.7L4 10l5.8-2.4L12 2z" fill="#8ab4ff"/></svg>';
      return a;
    }
    function addMsg(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      const av = avatar(who === 'user');
      const body = document.createElement('div');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text || '';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = who === 'user' ? 'You' : 'Assistant';
      body.appendChild(bubble); body.appendChild(meta);
      row.appendChild(av); row.appendChild(body);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    // Health ping
    (async () => {
      try {
        const r = await fetch(API_BASE + '/health');
        const j = await r.json().catch(()=> ({}));
        if (!j.has_api_key) showToast('‚ö†Ô∏è Backend missing OPENAI_API_KEY');
      } catch {
        addMsg('‚ö†Ô∏è Cannot reach backend at ' + API_BASE, 'bot');
      }
    })();

    // Recording
    recBtn.onclick = async () => {
      if (recording || busy) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
        mediaRecorder = new MediaRecorder(stream, { mimeType: mime, audioBitsPerSecond: 128000 });
        chunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
          addMsg('üé§ Voice message', 'user');
          await sendAudio(blob);
        };
        mediaRecorder.start();
        recording = true;
        recBtn.disabled = true; stopBtn.disabled = false; setStatus('Recording‚Ä¶');
      } catch (e) {
        console.error(e); addMsg('Mic error: ' + e.message, 'bot'); setStatus('Idle');
      }
    };

    stopBtn.onclick = () => {
      if (!recording) return;
      mediaRecorder.stop();
      recording = false;
      recBtn.disabled = false; stopBtn.disabled = true; setStatus('Processing‚Ä¶');
    };

    // Send to backend
    async function sendAudio(blob){
      if (busy) { addMsg('‚è≥ Still processing‚Ä¶', 'bot'); return; }
      busy = true;

      const fd = new FormData();
      fd.append('file', blob, 'audio.webm');

      const lang = (langHintSel.value || 'auto');
      const url = `${API_BASE}/chat/?lang=${encodeURIComponent(lang)}`;

      try {
        const resp = await fetch(url, { method:'POST', body: fd });
        if (!resp.ok) {
          const t = await resp.text().catch(()=> '');
          throw new Error('HTTP ' + resp.status + ': ' + (t || resp.statusText));
        }
        const data = await resp.json();
        if (data.user_text) addMsg('üìù ' + data.user_text, 'bot');
        if (data.bot_reply) addMsg(data.bot_reply, 'bot');
        setStatus('Idle');
      } catch (e) {
        console.error(e);
        addMsg('Error contacting server: ' + e.message, 'bot');
        setStatus('Error');
        showToast('Backend error ‚Äî check console');
      } finally {
        busy = false;
      }
    }
  </script>
  </body>
</html>
